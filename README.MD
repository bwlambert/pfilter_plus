## Build instructions

---

After pulling the repository, and assuming the presence of a C++ compiler, you should be able to build the executable by calling make:

```sh
git clone https://github.com/bwlambert/pfplus.git

cd pfplus
make
```

If using novel data, you will want to create a new directory for the novel data, and run the "create_country_data.R" script in that directory.

If the appropriate input CSV files are present, it will generate all demographic and SIA input files for all available countries, in time-shifted and non-shifted forms.

```sh
mkdir Data_for_fitting202X
cd Data_for_fitting202X
cp ../202X_input_data_WHO_format.zip .
unzip 202X_input_data_WHO_format.zip 
Rscript create_country_data.R
```

<br />

## Executing a grid search

---

To execute a parameter grid search for a specific country, in this case Nigeria, you can use the following command:

```sh
./pfpp 1 NGAnormal Data_for_fitting2019/NGA.txt Data_for_fitting2019/siaNGA.txt 0 0.5 0.01

```

In the above command, the number "1" acts as a flag to initiate a full grid search, "NGAnormal" is a string containing the standard ISO3 code that names the "country" of the run and the model which will be run.

The next argument provides the path to the "NGA.txt" file which contains a data frame of demographic information, and "siaNGA.txt" contains age-specific SIA information.

The next argument is an integer which determines which model will be run.  The relationship between model tags and number is detailed in a table below.

The remaining two arguments are floating point values representing the amount of noise desired for the simulations and the contribution of a Cauchy-distributed weight.

The following table describes each argument. 

| Command line argument | Description |
| :------------- |  :----------- |
| ./pfpp | Binary location  | 
| 1 | Action; "1" for grid search   | 
| NGAnormal | Country and Model tag string | 
| Data_for_fitting2019/NGA.txt | Path to demographic data  | 
| Data_for_fitting2019/siaNGA.txt | Path to SIA data  | 
| 0 | Model number  | 
| 0.5 | Sigma  | 
| 0.01 | Cauchy weight  | 

The following table shows the correspondence between model names and numbers:

| Model       | Model Tag    | Model Number     |
| :------------- | :----------: | -----------: |
|  Normal, no discounting | "normal"   | 0    |
|  Discounting MCV2  | "mcv2"   | 1    |
|  Discounting SIAs  | "sia"   | 2    |
|  Discounting MCV2 and SIAs  | "mcv2sia"   | 3    |



After the grid search has completed, the following files will be produced:

### Example output files
| Output filename | Description |
| :------------- |  :----------- |
| NGAnormal_runs_showing_penalty.txt | All parameter sets from the full grid search, with their nLLs | 
| Iest_NGAnormal.txt | The best performing parameter set, with nLL  | 
| NGAnormal_s_particles_fxsave.txt | For the best-performing parameter set, the "S" compartments for every particle, for every year  | 
| NGAnormal_i_particles_fxsave.txt | For the best-performing parameter set, the "I" compartments for every particle, for every year | 
| NGAnormal_iap_particles_fxsave.txt | For the best-performing parameter set, the "I" compartments for every particle, for every age, for every year |   
| NGAnormal_post-modification.txt | Demographic data, after application of any discounts  | 
| siaNGAnormal_post-modification.txt | SIA data, after application of any discounts  | 

The first file contains the negative log likelihoods generated by each run alongside the four parameters sampled from in that run.  

The Iest file contains the contains the best negative log likelihood value as well the parameter set that led to it, and the SOpct value.

All of the "particle" files contain compartment counts for the best-performing parameter set discovered in the grid search. 


The "s_particles" and "i_particles" files are space-delimited files, in which each row contains the sum of all age classes for either the "S" or "I" compartments of each particle in a given year.  

Thus, these files will have a number of entries per row equal to the number of particles, and a number of rows equal to the number of years.


The "iap_particles" file is also space-delimited, each row contains "I" compartment counts for every age class for a single particle, for a single year.  

All particles for a given year are listed in order, and after all particles for the year have been written, particles for the next year will follow. 

This file can be consumed by the "pf_summarize_age_driver.R" script to provide summaries of the distribution of cases over ages and particles.


<br />

## Sampling a single parameter set

---

To sample from a single parameter set, we append one additional argument, namely the path to the file containing the parameter set to be sampled from.

In table format:

| Command line argument | Description |
| :------------- |  :----------- |
| ./pfpp | Binary location  | 
| 1 | Action; "5" for single parameter set sample   | 
| NGAnormal | Country and Model tag string | 
| Data_for_fitting2019/NGA.txt | Path to demographic data  | 
| Data_for_fitting2019/siaNGA.txt | Path to SIA data  | 
| 0 | Model number  | 
| 0.5 | Sigma  | 
| 0.01 | Cauchy weight  | 
| Iest_NGAnormal.txt | File containing a single set of parameters   | 

The format for the Iest_NGAnormal.txt file is extremely simple; it is identical to the format used to output the best performing single set of parameters from the grid search.  

The file contains six values, each on a separate line.  The values must be in the order displayed in the following table:


| Example value | Description |
| :------------- |  :----------- |
| 904.456 |  Negative Log Likelihood  | 
| 0.100042 | S0  | 
|  -7.09721 | Beta 0 parameter  | 
|   31.2566 | Beta 1 parameter | 
| 0.0346112 | Probability of reporting | 
| 0.0414386 | Probability of reporting in adjusted years | 


<br />

## Summarize distribution of cases over ages over best parameter sets

---

```sh
Rscript pf_summarize_age_driver.R 100 NGAnormal_runs_showing_penalty.txt 0.95 NGAnormal Data_for_fitting2019/NGA.txt Data_for_fitting2019/siaNGA.txt 0 0.5 0.01
```


### Description of command line arguments for summarization task
| Command line argument | Description |
| :------------- |  :----------- |
|Rscript | Invoke R interpreter  |
|pf_summarize_age_driver.R | Summarizer script   |
|100 | Number of sample draws from parameter sets  |
|NGAnormal_runs_showing_penalty.txt | File output from grid search with parameter sets and their nLLs  |
|0.95 | CI coverage  |
|NGAnormal |  CountryModel tag  |
|Data_for_fitting2019/NGA.txt | Path to demographic data file  |
|Data_for_fitting2019/siaNGA.txt | Path to SIA data file  |
|0 | Model number  |
|0.5 | Sigma  |
|0.01 | Cauchy weight  |

Will produce a file named "pf_summarizer_result_age_NGAnormal_0.5_0.01.dat" containing an R object with the following fields:


| Field | Description |
| :------------- |  :----------- |
| result$out_data | For every sample, for every particle, for every age, the "I" compartment count  |
| result$par_lik | Parameters for each sample, original nLL, and nLL achieved by this sample  |


Additionally, each sample generated in the age summarization task will output versions of the particle, parameters, and input files generated in the grid search task, with the sample number included in the file name.  The following table lists the files expected from the generation of the fiftieth sample, using the NGA "normal" model.


### Example output files from a single sample generated for the summarization task
| Output filename | Description |
| :------------- |  :----------- |
| Iest_single_NGAnormal_50.txt | The parameter set selected to generate the fiftieth sample  |
| NGAnormal_50_s_particles_fxsave.txt | "S" compartments for every particle, for every year  | 
| NGAnormal_50_i_particles_fxsave.txt |  "I" compartments for every particle, for every year | 
| NGAnormal_50_iap_particles_fxsave.txt |  "I" compartments for every particle, for every age, for every year |   
| NGAnormal_50_post-modification.txt | Demographic data, after application of any discounts  | 
| siaNGAnormal_50_post-modification.txt | SIA data, after application of any discounts  | 
